version: '3.9'

services:
  # WordPress with PHP-FPM
  wordpress:
    build:
      context: .
      dockerfile: Containerfile
    image: sinople-theme:dev
    container_name: sinople-wordpress
    restart: unless-stopped
    environment:
      - WORDPRESS_DB_HOST=db:3306
      - WORDPRESS_DB_NAME=${DB_NAME:-sinople}
      - WORDPRESS_DB_USER=${DB_USER:-sinople}
      - WORDPRESS_DB_PASSWORD=${DB_PASSWORD}
      - WORDPRESS_DEBUG=true
      - WORDPRESS_DEBUG_LOG=true
    volumes:
      - ./:/var/www/html/wp-content/themes/sinople:ro
      - wordpress_data:/var/www/html
    networks:
      - sinople_internal
    security_opt:
      - no-new-privileges:true
      - seccomp=seccomp.json
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    read_only: true
    tmpfs:
      - /tmp
      - /var/run
    depends_on:
      db:
        condition: service_healthy

  # MariaDB database
  db:
    image: cgr.dev/chainguard/mariadb:latest
    container_name: sinople-db
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=${DB_NAME:-sinople}
      - MYSQL_USER=${DB_USER:-sinople}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_RANDOM_ROOT_PASSWORD=1
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - sinople_internal
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Nginx web server
  nginx:
    image: cgr.dev/chainguard/nginx:latest
    container_name: sinople-nginx
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - wordpress_data:/var/www/html:ro
    networks:
      - sinople_internal
      - sinople_external
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
    depends_on:
      - wordpress

  # Redis cache (optional)
  redis:
    image: cgr.dev/chainguard/redis:latest
    container_name: sinople-redis
    restart: unless-stopped
    networks:
      - sinople_internal
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ for BEAM interoperability
  rabbitmq:
    image: cgr.dev/chainguard/rabbitmq:latest
    container_name: sinople-rabbitmq
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-sinople}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    ports:
      - "127.0.0.1:5672:5672"
      - "127.0.0.1:15672:15672"
    networks:
      - sinople_internal
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Elixir/Phoenix for BEAM integration (optional)
  beam:
    image: cgr.dev/chainguard/elixir:latest
    container_name: sinople-beam
    restart: unless-stopped
    environment:
      - MIX_ENV=dev
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
    volumes:
      - ./beam:/app:ro
    networks:
      - sinople_internal
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    depends_on:
      rabbitmq:
        condition: service_healthy

networks:
  sinople_internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.28.0.0/16
  sinople_external:
    driver: bridge

volumes:
  wordpress_data:
  db_data:
